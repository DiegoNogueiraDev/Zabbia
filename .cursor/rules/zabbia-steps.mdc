---
description: 
globs: 
alwaysApply: true
---
# zabbia.mdc â€“ Master Design Contract Â· **REVâ€‘3** (2025â€‘04â€‘23)

> **Status:** Draft â€“ pending Product Owner approval  
> **Scope:** Define generation & runtime behaviour of the Zabbia Copilot.

---

## 1 Â· VisÃ£o Geral do Projeto
**Zabbia** Ã© um _AI Copilot_ especializado em **Observabilidade Zabbix 6.0+**.  
O sistema combina **LLM (OpenRouter â€º meta-llama/llama-4-maverick:free)** com **consultas SQL/API** para transformar linguagem natural em insight tÃ©cnico, grÃ¡ficos e automaÃ§Ãµes.

### 1.1 Objetivos SMART
| Meta | Indicador | Alvo |
|------|-----------|------|
| **Insight RÃ¡pido** | LatÃªncia da 1Âª resposta | â‰¤ 3â€¯s |
| **Cobertura** | NÂ° de intents mapeadas | â‰¥ 95â€¯% CUs |
| **Licenciamento** | Tentativas de uso sem licenÃ§a | 0 |

---

## 2 Â· Casos de Usoâ€‘NÃºcleo (CU)
| ID | NL Exemplo | Tipo | SaÃ­da | Prioridade |
|----|------------|------|-------|------------|
| CUâ€‘01 | "Hosts com CPU >â€¯80â€¯% (30â€¯min)" | query | tabela | P0 |
| CUâ€‘02 | "GrÃ¡fico RAM db01 24â€¯h" | graph | JSON chart | P0 |
| CUâ€‘03 | "Coloque web02 em manutenÃ§Ã£o 2â€¯h" | action | API call | P1 |
| CUâ€‘04 | "Resuma alertas crÃ­ticos de hoje" | summary | markdown | P1 |
| CUâ€‘05 | "Prever uso disco web cluster 7â€¯d" | predict | chart + texto | P2 |

---

## 3 Â· Arquitetura FÃ­sica
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  WebSocket  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” gRPC/json â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Next.js Frontend   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ FastAPI Gateway    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ LLM MCP Server â”‚
â”‚  (Dashboard, Chat) â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  Auth+Licensing    â”‚   async   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚  SQL Layer (SQLModel)           â–²
       â–²                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
       â”‚        REST /api             ðŸ”„Cache Layer (Redis)          â”‚
       â–¼                                                           SQL/API
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Zabbix DB + API                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4 Â· Contrato de IntegraÃ§Ã£o MCP
### 4.1 Formatos Padronizados
- **SQL** â†’ bloco ```SQL>``` seguido de consulta parametrizada (`:from`, `:to`, `:limit`).
- **API** â†’ bloco ```API>``` + mÃ©todo JSONâ€‘RPC.
- **GrÃ¡fico** â†’ bloco ```PLOT_SCHEMA>``` contendo:
```json
{"chartType":"line","labels":["2025â€‘04â€‘22T18:00Z",â€¦],"datasets":[{"label":"CPU%","data":[12,45,â€¦]}]}
```
- **Tabela** â†’ markdown, mÃ¡x 50 linhas; excedente = *â€¦ (+n)*.

### 4.2 DetecÃ§Ã£o de IntenÃ§Ã£o
Algoritmo seq.: `regex hints` â†’ `OpenAI functionâ€‘calling` â†’ *fallback heur.*

### 4.3 Regras de SeguranÃ§a
1. Sempre **bindâ€‘params**; proibir `;` e `--` fora de string.  
2. Verificar `X-License-Key` antes de qualquer aÃ§Ã£o de escrita.  
3. Limite 60 req/min/token (Redisâ€‘Leakyâ€‘Bucket).

---

## 5 Â· Modelos de Dados Essenciais Zabbix 6
| Tabela | FKs | ObservaÃ§Ãµes |
|--------|-----|-------------|
| `hosts` | interfaceid, proxy_hostid | status: 0=up 1=down |
| `items` | hostid | key_ exemplos: `system.cpu.util[,idle]`, `vm.memory.size[available]` |
| `history_uint` | itemid | Para value_type 3 |
| `history` (float) | itemid | value_type 0 |
| `triggers` | expression | priority 0â€‘5 |
| `events` | triggerid | value 1=PROBLEM, 0=OK |

#### 5.1 Templates SQL ReutilizÃ¡veis
```sql
-- avg CPU util last X minutes
SELECT h.hostid, h.name,
       100 - avg(hu.value) AS cpu
FROM hosts h
JOIN items i USING(hostid)
JOIN history_uint hu USING(itemid)
WHERE i.key_='system.cpu.util[,idle]'
  AND hu.clock > :since
GROUP BY 1,2
HAVING 100 - avg(hu.value) > :threshold
ORDER BY cpu DESC;
```

---

## 6 Â· UI & UX
- **Sidebar**: `Dashboard`, `Chat`, `ConfiguraÃ§Ãµes` â€“ Ã­cones Lucide.  
- **Dashboard** Widgets:
  1. CPU/RAM/Disk lineâ€‘chart por host/cluster.
  2. Tabela _Hosts em Alerta_.
  3. KPI cards Uptime mÃ©dio, Triggers ativas.
- **Estilo**: Tailwind v3, glassâ€‘morphism opcional, tema Dark/Light com `next-themes`.
- **Motion**: Framer Motion `layout` anim para troca de rota.

---

## 7 Â· Licenciamento
| Campo JWT | Tipo | Exemplo |
|-----------|------|---------|
| `cust` | string | "ACME" |
| `exp` | epoch  | 1767139200 |
| `seats` | int   | 20 |

Middleware `verify_license` bloqueia se `exp < now` ou contagem ativa > seats.
CLI:
```bash
python -m licensing.generate --customer "ACME" --seats 20 --days 365
```

---

## 8 Â· Qualidade & Observabilidade
- **Testes**: pytestâ€‘cov â‰¥â€¯90â€¯%; jest+RTL â‰¥â€¯90â€¯%; playwright smoke.  
- **CI**: GitHub Actions (lint, test, build, Docker push).  
- **Metrics**: Prometheus â€‘ scrape backend; Grafana dashboard _Zabbia Health_.

---

## 9 Â· Comandos do Agente
| Comando | DescriÃ§Ã£o |
|---------|-----------|
| `/init` | Gera scaffold completo. |
| `/sql <Q>` | Somente SQL. |
| `/graph <Q>` | Somente JSON Schema. |
| `/api <A>` | Somente payload Zabbix API. |
| `/test <domÃ­nio>` | Caso de teste unitÃ¡rio. |

---

## 10 Â· CritÃ©rios de Aceite Final
1. **docker compose up** â†’ sucesso; frontend em `:3000`, backend `:8000/docs`.  
2. Dashboard exibe 3 grÃ¡ficos + tabela; atualizaÃ§Ã£o mÃ¡x 30â€¯s.  
3. LicenÃ§a invÃ¡lida â†’ 401 + JSON erro.  
4. Lighthouse PWA score â‰¥â€¯90.  
5. Todo CUâ€‘P0 atendido.

---

## 11 Â· Chave de ConclusÃ£o
Responder `DONE::<feature>` quando completar qualquer entrega rastreÃ¡vel.

---

> **Fim do Documento â€“ AlteraÃ§Ãµes requerem revisÃ£o do Productâ€¯Owner & versionamento semÃ¢ntico.**

